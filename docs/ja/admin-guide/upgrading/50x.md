# GROWI v5.0.x へのアップグレード

v5.0 では、全ページの階層構造を表示できるページツリーがサイドバーに追加されました。  
それに伴ってページの移動・リネーム・削除時の子孫ページの取り扱いの仕様に大きな変化があります。

::: danger
「自分にのみ公開」「グループにのみ公開」ページに意図しない変更が加わることを避けるため、
管理者の方はこのアップグレードガイドをチェックし、利用者の方に変更点についての注意喚起を行ってください。
:::

## 新しい v5 互換形式について

v5.0 では、ページのデータ形式が大きく変わりました。

- v5.0 アップグレード後に新たに作成したページは、全て「新しい v5 互換形式」で作成されます
- v4.5 までに作成されたページは、新しい v5 互換形式には**自動では変換されません**
  - 管理者または一般ユーザーが明示的に変換操作を行うことにより、新しい v5 互換形式に変換できます

::: tip
v5 互換形式に変換されていないページに関してもこれまで通り閲覧・編集・管理が可能ですが、v5.0 で新しく実装された機能を利用できません。
:::

### 新しい v5 互換形式へのアップグレード操作

管理者ユーザーは、管理ページから全ての公開(パブリック)ページに関して v5 互換形式への変換処理を実行できます。
この操作で、ページツリーに変換済みの公開(パブリック)ページが表示されるようになります。

プライベートページに関しては、ページツリーの最下部にあるリンクをクリックするか、
あるいは `/_private-legacy-pages` に直接アクセスすることで、新しい v5 互換形式に変換できます。
ログイン中のユーザーが閲覧可能なページの一覧が表示されるので、その中から変換したいページを選択し、
「一括変換」ドロップダウンを利用して変換してください。

### 変換前後の挙動の差異

|  | v4.5 以前に作成されたデータ | 新しい v5 互換形式のデータ |
|:--|:------------:|:------------:|
| ページツリーへの表示 | 表示されない | 表示される |
| 子孫ページを伴う移動 | 閲覧可能なページのみ処理 | 配下の全てのページを処理<br>(ただし新しい v5 互換形式のページに限る) |
| 子孫ページを伴う削除 | 閲覧可能なページのみ処理 | 配下の全てのページを処理<br>(ただし新しい v5 互換形式のページに限る) |
| 子孫ページに設定可能な閲覧権限 | 全ての種類の権限を設定可能 | 親ページよりも範囲の狭い権限のみ設定可能 |



## ページツリー

v5.0 では、全ページの階層構造を表示できるページツリーがサイドバーに追加されました。ツリー状の UI になっているので、配下ページを開閉して表示させたり、ドラッグ＆ドロップでページを移動させたりできるようになりました。

::: warning
ページツリーに表示されるデータは、新しい v5 互換形式のページのみです。
:::


## ページの移動・リネーム・削除処理の仕様変更

新しい v5 互換形式のページは、移動・リネーム・削除処理を行ったときの挙動が v4.5 以前とは異なっています。

v4.5 までは、移動・リネーム・削除処理時に「子孫ページを伴って処理するかどうか」を選択可能でしたが、  
v5.0 では、移動・リネーム・削除は基本的に子孫ページを伴う操作になります(選択不可)。

また、v4.5 までは「子孫ページを伴って処理する」選択をしても、操作するユーザーにより閲覧できないページが配下にあった場合、それらは処理されないまま残る仕様でした。
v5.0 では、例え子孫ページの閲覧権限がなくとも一緒に移動・リネーム・削除されます。


## ページパスの重複を許容

v4.5 までは、ページパスはシステム内でユニークなものであり、同じページパスのページは作成が不可能でした。

v5.0 ではページツリーの実装に伴い、ページの移動やリネームをこれまでよりも高速に処理する必要がありました。そのトレードオフとして、これまでユニークだったページパスは重複を許容するように変更されました。その影響を以下に列挙します。

### [仕様変更] ブラウザの URL バーに表示される URL がパーマリンクに

v4.5 までは、ページ閲覧・遷移時の URL は `/Page1/Page1-1/...` というページパスベースでした。ページのIDで表現されるパーマリンクによるアクセスも、ページパスにリダイレクトされていました。

v5.0 では完全に逆になり、ページ閲覧・遷移時の URL はページのIDで表現されるパーマリンクになります。一方ページパスでのアクセスは、ページのIDで表現されるパーマリンクにリダイレクトされます。

この仕様変更は、利用時に意識する必要はありません。URL を共有する際は、ページパスベースの URL、パーマリンクいずれも問題なく共有していただいて構いません。

### [機能追加] 重複検知

v5.0 では同一のページパスを持つ複数のページが存在しうることになります。
そのため、例えば `/Page1/Page1-1/...` というページパスベースの URL でアクセスした際に当該パスに紐付くページが複数存在した際は、重複している旨を表す以下のようなページが表示されます。ユーザーはリスト内から一つを選ぶことで、そのページに遷移することが可能です。

::: tip

- ページパスの重複は、「副作用的に起こってしまう状態」です
- ユーザーが意図的にページパスが重複するページを作成することは想定しておらず、そのような操作を行うための機能は用意しておりません
:::


## ユーザーグループの親子設定

v5.0 では、ユーザーグループ同士で親子関係を設定できるようになりました。

例えば「技術部」グループの子グループとして、「UI/UXチーム」を作成し、技術部グループ内の一部のメンバーを登録できます。

### ページに対する閲覧権限の設定の仕様変更

v4.5 までは、どのページに対しても自由に閲覧権限を設定可能でした。

v5.0 では、あるページ `/Page1` の配下ページには、同じ閲覧権限か、またはより強い制限となるような閲覧権限しか付けられないようになりました。

以下の例は、`/Page1` の閲覧権限によって、配下ページである `/Page1/child` にどのような閲覧権限であれば付与可能なのかを表した表です。

| `/Page1` の閲覧権限 | `/Page1/child` に設定可能な閲覧権限 | 可能/不可能 |
|:--|:------------:|:------------:|
| 公開 | 公開 | :white_check_mark: |
| 公開 | 自分のみ | :white_check_mark: |
| 公開 | 特定グループのみ | :white_check_mark: |
| 自分のみ | 公開 | :x: |
| 自分のみ | 自分のみ | :white_check_mark: |
| 自分のみ | 特定グループのみ | :x: |
| 特定グループのみ | 公開 | :x: |
| 特定グループのみ | 自分のみ | :white_check_mark: |
| 特定グループのみ | 特定グループのみ | (グループの親子関係に依存) |

### ページに対する「特定グループのみ」設定の仕様変更

「特定グループのみ」設定の場合も、配下ページには親ページと同じ閲覧権限か、またはより強い制限(メンバーの範囲の狭いグループ)となるような閲覧権限のみ可能です。

以下の例は、「社内全体」グループの子グループに「技術部」グループ、更にその子グループに「UI/UXチーム」グループを作成していた場合に、配下ページである `/Page1/child` に対しどのような閲覧権限であれば付与可能なのかを表した表です。

| `/Page1` の閲覧権限 | `/Page1/child` に設定可能な閲覧権限 | 可能/不可能 |
|:--|:------------:|:------------:|
| 特定グループのみ(技術部) | 特定グループのみ(技術部) | :white_check_mark: |
| 特定グループのみ(技術部) | 特定グループのみ(社内全体) | :x: |
| 特定グループのみ(技術部) | 特定グループのみ(UI/UXチーム) | :white_check_mark: |


### ページに対する「特定グループのみ」設定の仕様変更

v4.5 までは、どのページに対しても自由に閲覧権限を設定可能でした。

v5.0 では、あるページ `/Page1` の配下ページには、同じ閲覧権限か、またはより強い制限となるような閲覧権限しか付けられないようになりました。

以下の例は、`/Page1` の閲覧権限によって、配下ページである `/Page1/child` にどのような閲覧権限であれば付与可能なのかを表した表です。

| `/Page1` の閲覧権限 | `/Page1/child` に設定可能な閲覧権限 | 可能/不可能 |
|:--|:------------:|:------------:|
| 公開 | 公開 | :white_check_mark: |
| 公開 | 自分のみ | :white_check_mark: |
| 公開 | 特定グループのみ | :white_check_mark: |
| 自分のみ | 公開 | :x: |
| 自分のみ | 自分のみ | :white_check_mark: |
| 自分のみ | 特定グループのみ | :x: |
| 特定グループのみ | 公開 | :x: |
| 特定グループのみ | 自分のみ | :white_check_mark: |
| 特定グループのみ(技術部) | 特定グループのみ(技術部) | :white_check_mark: |
| 特定グループのみ(技術部) | 特定グループのみ(社内全体) | :x: |
| 特定グループのみ(技術部) | 特定グループのみ(UI/UXチーム) | :white_check_mark: |


## 削除処理の権限管理





## アップグレード前にチェックすべきこと

- [x]
- [x]

