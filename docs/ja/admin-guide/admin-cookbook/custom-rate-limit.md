# Custom rate limitの設定

GROWIでのAPIのrate limitについて紹介します。

## 概要

エンドポイントとリクエストメソッドに対して、一定時間内のリクエスト数に制限をかけることができます。`/login`の`GET`メソッドに、60秒に10回という制限がかかっていた場合は、60秒以内に11回以上のリクエストが送られたときに、`419 too many requests`のエラーを返します。60秒が経過すると、再度リクエストを送ることができるようになります。


### ログイン済みユーザーの場合

ログイン済みユーザーの場合、制限をかけるためのkeyは**エンドポイント**と**リクエストメソッド**と**ユーザーID**を含めた文字列のハッシュ値になります。同じIPアドレスからのリクエストもユーザーごとに区別できます。

### 未ログインユーザーの場合

未ログインユーザーの場合、制限をかけるためのkeyは**エンドポイント**と**リクエストメソッド**と**IPアドレス**を含めた文字列のハッシュ値になります。この時、最大リクエスト数には、1IPアドレス当たりの想定人数をかけた値が利用されます。1IPアドレス当たりの想定人数は、デフォルトでは5人/ipとなっています。1IPアドレス当たりの想定人数は、環境変数を用いてエンドポイントとメソッドごとにカスタマイズできます。

## デフォルトの設定


エンドポイントにはデフォルトで下の表の制限がかけられています。

| 時間(秒) | 最大リクエスト数（回） | IPアドレス当たりの想定人数 |
| -------- | ---------------------- | -------------------------- |
| 60       | 500                    | 5                          |


### 初期値がカスタマイズされているエンドポイント

その他、制限が必要なエンドポイントには下の表のように、デフォルトでカスタマイズされた初期値が制限として設定されています。

| エンドポイント            | メソッド | 時間(秒) | 最大リクエスト数（回） | IPアドレス当たりの想定人数 |
| ------------------------- | -------- | -------- | ---------------------- | -------------------------- |
| /_api/v3/healthcheck      | POST     | 60       | 60                     | 1                          |
| /installer                | POST     | 60       | 5                      | 1                          |
| /login                    | POST     | 60       | 5                      | 100                        |
| /login/activateInvited    | POST     | 60       | 20                     | 5                          |
| /register                 | POST     | 60       | 5                      | 20                         |
| /user-activation/register | POST     | 60       | 5                      | 20                         |
| /_api/login/testLdap      | POST     | 60       | 20                     | 1                          |
| /_api/check_username      | GET      | 60       | 50                     | 5                          |
| /forgot-password/.*       | ALL      | 60       | 5                      | 5                          |
| /user-activation/.*       | GET      | 60       | 5                      | 5                          |
| /attachment/[0-9a-z]{24}  | GET      | 60       | 100                    | 5                          |
| /download/[0-9a-z]{24}    | GET      | 60       | 100                    | 5                          |
| /share/[0-9a-z]{24}       | GET      | 60       | 100                    | 5                          |



## 制限のカスタマイズ

デフォルトの制限を上書きして、カスタイマイズするためには環境変数を用いて設定します。

### 設定例

``` bash
API_RATE_LIMIT_010_FOO_ENDPOINT=/_api/v3/foo
API_RATE_LIMIT_010_FOO_METHODS=GET,POST
API_RATE_LIMIT_010_FOO_MAX_REQUESTS=10
API_RATE_LIMIT_010_FOO_USERS_PER_IP=2
```

#### 設定項目

環境変数で設定する項目は以下の3つです。

- エンドポイント(必須)
- リクエストメソッド
- 60秒当たりの最大リクエスト数(必須)
- 1IPアドレス当たりの想定人数

リクエストメソッドの以外の設定は任意です。設定されていない場合、そのエンドポイントに対するすべてのメソッドに対して制限がかけられます。1IPアドレス当たりの想定人数は、設定されていない場合はデフォルト値の5が設定されます。

#### 環境変数のkeyについて

``` bash
API_RATE_LIMIT_[KEY]_ENDPOINT=/_api/v3/foo
API_RATE_LIMIT_[KEY]_METHODS=GET,POST
API_RATE_LIMIT_[KEY]_MAX_REQUESTS=10
API_RATE_LIMIT_[KEY]_USERS_PER_IP=2
```

環境変数のkeyには上のような文字列を設定します。`[key]`の部分は任意の文字列です。ただし、同じエンドポイントに対して制限が設定されていた場合、`[key]`の部分をin-placeアルゴリズム(JavaScriptのsort()メソッド)でソートしたときに、後に来るkeyの設定を優先します。


### 正規表現を用いた環境変数のカスタマイズ

``` bash
GET '/62df87c8539c3090b8cc7621' // ページの閲覧
GET '/share/62e2256f19e932f82eebe830' // 共有ページの閲覧
```

上のような、可変的なエンドポイントの制限は正規表現と環境変数を用いて制限をカスタマイズできます。

### 設定例

``` bash
API_RATE_LIMIT_010_SHARE_ENDPOINT_WITH_REGEXP=/share/[0-9a-z]{24}
API_RATE_LIMIT_010_SHARE_METHODS=GET
API_RATE_LIMIT_010_SHARE_MAX_REQUESTS=20
API_RATE_LIMIT_010_SHARE_USERS_PER_IP=2
```

